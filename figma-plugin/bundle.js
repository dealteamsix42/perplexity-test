#!/usr/bin/env node

/**
 * Simple bundler to combine all plugin modules into a single file
 * This is needed because Figma plugins don't support ES6 imports
 */

const fs = require('fs');
const path = require('path');

const libDir = path.join(__dirname, 'lib');
const outputFile = path.join(__dirname, 'code-bundled.js');

// Read all module files in order
const modules = [
  'utils.js',
  'variables.js',
  'text-styles.js',
  'effects.js',
  'gradients.js',
  'components.js',
  'templates.js'
];

let bundledCode = `/**
 * Figma Plugin: Design Token Sync (Bundled)
 * This file is auto-generated by bundle.js
 * DO NOT EDIT MANUALLY - Edit the files in lib/ and run bundle.js
 */

`;

// Read and process each module
for (const moduleFile of modules) {
  const modulePath = path.join(libDir, moduleFile);
  if (fs.existsSync(modulePath)) {
    let moduleCode = fs.readFileSync(modulePath, 'utf8');
    
    // Remove export statements and convert to function declarations
    moduleCode = moduleCode.replace(/export\s+(async\s+)?function/g, '$1function');
    moduleCode = moduleCode.replace(/export\s+const/g, 'const');
    moduleCode = moduleCode.replace(/export\s+{([^}]+)}/g, '');
    
    // Remove import statements (we'll inline everything)
    moduleCode = moduleCode.replace(/import\s+{([^}]+)}\s+from\s+['"].*['"];?\n?/g, '');
    
    bundledCode += `\n// === ${moduleFile} ===\n\n`;
    bundledCode += moduleCode;
    bundledCode += '\n\n';
  }
}

// Read main code.js and replace imports with direct function calls
let mainCode = fs.readFileSync(path.join(__dirname, 'code.js'), 'utf8');

// Remove import statements
mainCode = mainCode.replace(/import\s+{([^}]+)}\s+from\s+['"].*['"];?\n?/g, '');

bundledCode += `\n// === Main Plugin Code ===\n\n`;
bundledCode += mainCode;

// Write bundled file
fs.writeFileSync(outputFile, bundledCode);
console.log(`âœ… Bundled plugin code written to: ${outputFile}`);
console.log(`\nNote: Update manifest.json to use 'code-bundled.js' as the main file, or rename it to 'code.js'`);

